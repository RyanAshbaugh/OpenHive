#!/bin/bash
set -euo pipefail

# ============================================================================
# ohmobile — CLI entry point for @openhive/mobile
# ============================================================================
#
# Usage:
#   ohmobile <command> [options]
#
# Commands:
#   run              Build, launch, and authenticate (full flow)
#   run --skip-build Use cached build
#   run --skip-auth  Skip authentication
#   auth             Authenticate on running simulator
#   creds            Set up keychain credentials
#   creds --verify   Verify stored credentials
#   creds --delete   Delete stored credentials
#   stop             Stop this project's Metro bundler
#   stop --sim       Stop Metro and shut down simulator
#   scenes           List available simulation scenes
#   simulate <scene> Trigger a simulation scene via deep link
#   record <scene>   Record a simulation (stub — not yet implemented)
#   help             Show this help
#

# Resolve symlinks so npm-linked installs find the real package location
_SELF="${BASH_SOURCE[0]:-$0}"
while [ -L "$_SELF" ]; do
  _DIR="$(cd "$(dirname "$_SELF")" && pwd)"
  _SELF="$(readlink "$_SELF")"
  [[ "$_SELF" != /* ]] && _SELF="$_DIR/$_SELF"
done
BIN_DIR="$(cd "$(dirname "$_SELF")" && pwd)"
SCRIPTS_DIR="$BIN_DIR/../scripts"

CMD="${1:-help}"
shift 2>/dev/null || true

# Load config for commands that need it
_load_config() {
  export PROJECT_DIR="${PROJECT_DIR:-$(pwd)}"
  source "$SCRIPTS_DIR/_load-config.sh"
}

# Find and list scene files in the project
_list_scenes() {
  local scenes_dir=""
  # Search common locations for scenes directory
  for candidate in \
    "$PROJECT_DIR/src/simulation/scenes" \
    "$PROJECT_DIR/simulation/scenes" \
    "$PROJECT_DIR/scenes"; do
    if [ -d "$candidate" ]; then
      scenes_dir="$candidate"
      break
    fi
  done

  if [ -z "$scenes_dir" ]; then
    echo "No scenes directory found."
    return 1
  fi

  local rel_dir="${scenes_dir#"$PROJECT_DIR"/}"
  echo "Scenes ($rel_dir/):"
  echo ""
  local found=false
  for f in "$scenes_dir"/*.js; do
    [ -f "$f" ] || continue
    local scene_name
    scene_name="$(basename "$f" .js)"
    [ "$scene_name" = "index" ] && continue
    echo "  $scene_name"
    found=true
  done
  if [ "$found" = false ]; then
    echo "  (none)"
  fi
  echo ""
}

case "$CMD" in
  run)
    exec "$SCRIPTS_DIR/build-and-run.sh" "$@"
    ;;
  auth)
    exec "$SCRIPTS_DIR/authenticate-sim.sh" "$@"
    ;;
  creds|credentials)
    exec "$SCRIPTS_DIR/setup-credentials.sh" "$@"
    ;;
  scenes)
    _load_config
    _list_scenes
    ;;
  simulate)
    _load_config
    SCENE="${1:-}"
    if [ -z "$SCENE" ] || [ "$SCENE" = "--list" ]; then
      echo "Usage: ohmobile simulate <scene>"
      echo ""
      echo "Sends a deep link to the running simulator to trigger a simulation scene."
      echo "The app must be running and authenticated first."
      echo ""
      _list_scenes
      exit 0
    fi
    shift
    SPEED="${1:-}"
    QUERY="scene=$SCENE"
    [ -n "$SPEED" ] && QUERY="$QUERY&speed=$SPEED"
    echo "Triggering simulation: $SCENE"
    # Dismiss any system alerts or error overlays before starting
    source "$SCRIPTS_DIR/sim-helpers.sh"
    dismiss_alerts
    xcrun simctl openurl "$SIM_NAME" "${DEEP_LINK_SCHEME}://simulate?$QUERY"
    ;;
  record)
    _load_config
    SCENE="${1:-}"
    if [ -z "$SCENE" ]; then
      echo "Usage: ohmobile record <scene> [--duration <seconds>]"
      echo ""
      echo "Starts screen recording, triggers simulation, waits, stops recording."
      echo "The app must be running and authenticated first."
      echo ""
      echo "Options:"
      echo "  --duration <sec>  Recording duration (default: 35)"
      echo ""
      echo "Example:"
      echo "  ohmobile record heatmap-timelapse"
      echo "  ohmobile record heatmap-timelapse --duration 45"
      exit 0
    fi
    shift

    DURATION=35
    while [ $# -gt 0 ]; do
      case "$1" in
        --duration) DURATION="$2"; shift 2 ;;
        *) shift ;;
      esac
    done

    RECORDINGS_DIR="$PROJECT_DIR/.openhive/recordings"
    mkdir -p "$RECORDINGS_DIR"
    TIMESTAMP=$(date +%Y%m%d-%H%M%S)
    OUTPUT="$RECORDINGS_DIR/${SCENE}-${TIMESTAMP}.mov"

    echo "=== Recording: $SCENE ==="
    echo "  Output:   $OUTPUT"
    echo "  Duration: ${DURATION}s"
    echo ""

    # Dismiss any system alerts or error overlays before recording
    source "$SCRIPTS_DIR/sim-helpers.sh"
    dismiss_alerts

    # Start recording in background
    xcrun simctl io "$SIM_NAME" recordVideo --codec h264 "$OUTPUT" &
    RECORD_PID=$!
    sleep 2

    # Trigger simulation
    echo "  Triggering simulation..."
    xcrun simctl openurl "$SIM_NAME" "${DEEP_LINK_SCHEME}://simulate?scene=$SCENE"

    # Wait for simulation + buffer
    echo "  Recording for ${DURATION}s... (Ctrl+C to stop early)"
    trap "kill -INT $RECORD_PID 2>/dev/null; wait $RECORD_PID 2>/dev/null; echo ''; echo 'Recording saved: $OUTPUT'; exit 0" INT
    sleep "$DURATION"

    # Stop recording (SIGINT for clean .mov finalization)
    kill -INT "$RECORD_PID" 2>/dev/null
    wait "$RECORD_PID" 2>/dev/null

    echo ""
    echo "Recording saved: $OUTPUT"

    # Auto-clean status bar
    if [ -f "$OUTPUT" ]; then
      echo "  Cleaning status bar..."
      CLEAN_ARGS=(--device "$SIM_NAME")
      [ -n "${NO_CLEAN:-}" ] && CLEAN_ARGS=()
      if [ ${#CLEAN_ARGS[@]} -gt 0 ]; then
        "$SCRIPTS_DIR/clean-video.sh" "$OUTPUT" "${CLEAN_ARGS[@]}"
      fi
    fi
    ;;
  stop)
    _load_config
    exec "$SCRIPTS_DIR/stop.sh" "$@"
    ;;
  clean)
    _load_config
    exec "$SCRIPTS_DIR/clean-video.sh" --device "$SIM_NAME" "$@"
    ;;
  help|--help|-h)
    echo "ohmobile — Mobile simulator automation tools"
    echo ""
    echo "Usage: ohmobile <command> [options]"
    echo ""
    echo "Commands:"
    echo "  run              Build, launch, and authenticate (full flow)"
    echo "  run --skip-build Use cached Xcode build"
    echo "  run --skip-auth  Skip authentication step"
    echo "  auth             Authenticate on running simulator"
    echo "  creds            Set up keychain credentials interactively"
    echo "  creds --verify   Verify stored credentials against API"
    echo "  creds --delete   Delete stored credentials"
    echo "  stop             Stop this project's Metro bundler"
    echo "  stop --sim       Stop Metro and shut down simulator"
    echo "  scenes           List available simulation scenes"
    echo "  simulate <scene> Trigger a simulation scene via deep link"
    echo "  record <scene>   Record screen during a simulation scene"
    echo "  clean <file>     Remove status bar from a video or screenshot"
    echo "  help             Show this help"
    echo ""
    echo "Configuration:"
    echo "  Place a mobile.json5 file at .openhive/mobile.json5 in your project root."
    echo "  Override with \$OPENHIVE_MOBILE_CONFIG env var."
    echo "  Override project root with \$PROJECT_DIR env var."
    ;;
  *)
    echo "Unknown command: $CMD"
    echo "Run 'ohmobile help' for usage."
    exit 1
    ;;
esac
