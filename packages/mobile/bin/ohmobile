#!/bin/bash
set -euo pipefail

# ============================================================================
# ohmobile — CLI entry point for @openhive/mobile
# ============================================================================
#
# Usage:
#   ohmobile <command> [options]
#
# Commands:
#   run              Build, launch, and authenticate (full flow)
#   run --skip-build Use cached build
#   run --skip-auth  Skip authentication
#   auth             Authenticate on running simulator
#   creds            Set up keychain credentials
#   creds --verify   Verify stored credentials
#   creds --delete   Delete stored credentials
#   simulate <scene> Trigger a simulation scene via deep link
#   record <scene>   Record a simulation (stub — not yet implemented)
#   help             Show this help
#

# Resolve symlinks so npm-linked installs find the real package location
_SELF="${BASH_SOURCE[0]:-$0}"
while [ -L "$_SELF" ]; do
  _DIR="$(cd "$(dirname "$_SELF")" && pwd)"
  _SELF="$(readlink "$_SELF")"
  [[ "$_SELF" != /* ]] && _SELF="$_DIR/$_SELF"
done
BIN_DIR="$(cd "$(dirname "$_SELF")" && pwd)"
SCRIPTS_DIR="$BIN_DIR/../scripts"

CMD="${1:-help}"
shift 2>/dev/null || true

# Load config for commands that need it
_load_config() {
  export PROJECT_DIR="${PROJECT_DIR:-$(pwd)}"
  source "$SCRIPTS_DIR/_load-config.sh"
}

case "$CMD" in
  run)
    exec "$SCRIPTS_DIR/build-and-run.sh" "$@"
    ;;
  auth)
    exec "$SCRIPTS_DIR/authenticate-sim.sh" "$@"
    ;;
  creds|credentials)
    exec "$SCRIPTS_DIR/setup-credentials.sh" "$@"
    ;;
  simulate)
    _load_config
    SCENE="${1:-}"
    if [ -z "$SCENE" ] || [ "$SCENE" = "--list" ]; then
      echo "Usage: ohmobile simulate <scene>"
      echo ""
      echo "Sends a deep link to the running simulator to trigger a simulation scene."
      echo "The app must be running and authenticated first."
      echo ""
      echo "Example:"
      echo "  ohmobile simulate heatmap-timelapse"
      exit 0
    fi
    shift
    SPEED="${1:-}"
    QUERY="scene=$SCENE"
    [ -n "$SPEED" ] && QUERY="$QUERY&speed=$SPEED"
    echo "Triggering simulation: $SCENE"
    xcrun simctl openurl "$SIM_NAME" "${DEEP_LINK_SCHEME}://simulate?$QUERY"
    ;;
  record)
    _load_config
    SCENE="${1:-}"
    if [ -z "$SCENE" ]; then
      echo "Usage: ohmobile record <scene>"
      echo ""
      echo "Starts screen recording, triggers simulation, waits for completion, stops recording."
      echo "(Not yet implemented — use 'simulate' for now.)"
      exit 0
    fi
    echo "Record command is not yet implemented."
    echo "Use 'ohmobile simulate $SCENE' to trigger the simulation manually."
    exit 1
    ;;
  help|--help|-h)
    echo "ohmobile — Mobile simulator automation tools"
    echo ""
    echo "Usage: ohmobile <command> [options]"
    echo ""
    echo "Commands:"
    echo "  run              Build, launch, and authenticate (full flow)"
    echo "  run --skip-build Use cached Xcode build"
    echo "  run --skip-auth  Skip authentication step"
    echo "  auth             Authenticate on running simulator"
    echo "  creds            Set up keychain credentials interactively"
    echo "  creds --verify   Verify stored credentials against API"
    echo "  creds --delete   Delete stored credentials"
    echo "  simulate <scene> Trigger a simulation scene via deep link"
    echo "  record <scene>   Record a simulation (not yet implemented)"
    echo "  help             Show this help"
    echo ""
    echo "Configuration:"
    echo "  Place a mobile.json5 file at .openhive/mobile.json5 in your project root."
    echo "  Override with \$OPENHIVE_MOBILE_CONFIG env var."
    echo "  Override project root with \$PROJECT_DIR env var."
    ;;
  *)
    echo "Unknown command: $CMD"
    echo "Run 'ohmobile help' for usage."
    exit 1
    ;;
esac
