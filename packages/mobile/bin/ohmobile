#!/bin/bash
set -euo pipefail

# ============================================================================
# ohmobile — CLI entry point for @openhive/mobile
# ============================================================================
#
# Usage:
#   ohmobile <command> [options]
#
# Commands:
#   run              Build, launch, and authenticate (full flow)
#   run --skip-build Use cached build
#   run --skip-auth  Skip authentication
#   auth             Authenticate on running simulator
#   creds            Set up keychain credentials
#   creds --verify   Verify stored credentials
#   creds --delete   Delete stored credentials
#   stop             Stop this project's Metro bundler
#   stop --sim       Stop Metro and shut down simulator
#   scenes           List available simulation scenes
#   simulate <scene> Trigger a simulation scene via deep link
#   record <scene>   Record a simulation (two-phase: setup then run)
#   generate-scene   Generate a scene JS file using an AI agent
#   help             Show this help
#

# Resolve symlinks so npm-linked installs find the real package location
_SELF="${BASH_SOURCE[0]:-$0}"
while [ -L "$_SELF" ]; do
  _DIR="$(cd "$(dirname "$_SELF")" && pwd)"
  _SELF="$(readlink "$_SELF")"
  [[ "$_SELF" != /* ]] && _SELF="$_DIR/$_SELF"
done
BIN_DIR="$(cd "$(dirname "$_SELF")" && pwd)"
SCRIPTS_DIR="$BIN_DIR/../scripts"

CMD="${1:-help}"
shift 2>/dev/null || true

# Load config for commands that need it
_load_config() {
  export PROJECT_DIR="${PROJECT_DIR:-$(pwd)}"
  source "$SCRIPTS_DIR/_load-config.sh"
}

# Find and list scene files in the project
_list_scenes() {
  local scenes_dir=""
  # Search common locations for scenes directory
  for candidate in \
    "$PROJECT_DIR/src/simulation/scenes" \
    "$PROJECT_DIR/simulation/scenes" \
    "$PROJECT_DIR/scenes"; do
    if [ -d "$candidate" ]; then
      scenes_dir="$candidate"
      break
    fi
  done

  if [ -z "$scenes_dir" ]; then
    echo "No scenes directory found."
    return 1
  fi

  local rel_dir="${scenes_dir#"$PROJECT_DIR"/}"
  echo "Scenes ($rel_dir/):"
  echo ""
  local found=false
  for f in "$scenes_dir"/*.js; do
    [ -f "$f" ] || continue
    local scene_name
    scene_name="$(basename "$f" .js)"
    [ "$scene_name" = "index" ] && continue
    echo "  $scene_name"
    found=true
  done
  if [ "$found" = false ]; then
    echo "  (none)"
  fi
  echo ""
}

case "$CMD" in
  run)
    exec "$SCRIPTS_DIR/build-and-run.sh" "$@"
    ;;
  auth)
    exec "$SCRIPTS_DIR/authenticate-sim.sh" "$@"
    ;;
  creds|credentials)
    exec "$SCRIPTS_DIR/setup-credentials.sh" "$@"
    ;;
  scenes)
    _load_config
    _list_scenes
    ;;
  simulate)
    _load_config
    SCENE="${1:-}"
    if [ -z "$SCENE" ] || [ "$SCENE" = "--list" ]; then
      echo "Usage: ohmobile simulate <scene>"
      echo ""
      echo "Sends a deep link to the running simulator to trigger a simulation scene."
      echo "The app must be running and authenticated first."
      echo ""
      _list_scenes
      exit 0
    fi
    shift
    SPEED="${1:-}"
    QUERY="scene=$SCENE"
    [ -n "$SPEED" ] && QUERY="$QUERY&speed=$SPEED"
    echo "Triggering simulation: $SCENE"
    # Dismiss any system alerts or error overlays before starting
    source "$SCRIPTS_DIR/sim-helpers.sh"
    dismiss_alerts
    xcrun simctl openurl "$SIM_NAME" "${DEEP_LINK_SCHEME}://simulate?$QUERY"
    ;;
  record)
    _load_config
    SCENE="${1:-}"
    if [ -z "$SCENE" ]; then
      echo "Usage: ohmobile record <scene> [options]"
      echo ""
      echo "Two-phase recording: sets up the scene (entities, navigation), waits"
      echo "for the UI to settle, starts recording, then runs the simulation."
      echo "The app must be running and authenticated first."
      echo ""
      echo "Options:"
      echo "  --duration <sec>      Simulation recording duration (default: from scene JS or 35)"
      echo "  --setup-delay <sec>   Wait after setup before recording (default: from scene JS or 6)"
      echo "  --run-delay <sec>     Wait after recording starts before running (default: from scene JS or 1)"
      echo ""
      echo "Defaults are read from the scene JS file's 'recording' block if present."
      echo ""
      echo "Example:"
      echo "  ohmobile record heatmap-timelapse"
      echo "  ohmobile record heatmap-timelapse --duration 20 --setup-delay 8"
      exit 0
    fi
    shift

    # Parse CLI flags first
    DURATION_FLAG=""
    SETUP_DELAY_FLAG=""
    RUN_DELAY_FLAG=""
    while [ $# -gt 0 ]; do
      case "$1" in
        --duration) DURATION_FLAG="$2"; shift 2 ;;
        --setup-delay) SETUP_DELAY_FLAG="$2"; shift 2 ;;
        --run-delay) RUN_DELAY_FLAG="$2"; shift 2 ;;
        *) shift ;;
      esac
    done

    # Read a numeric value from the scene JS file's recording block
    _scene_opt() {
      local file="$1" key="$2" default="$3"
      local val
      val=$(grep -oE "${key}:\s*[0-9.]+" "$file" 2>/dev/null | grep -oE '[0-9.]+$' | head -1)
      echo "${val:-$default}"
    }

    # Find scene file using the same search paths as _list_scenes
    _find_scene_file() {
      local scene="$1"
      for candidate in \
        "$PROJECT_DIR/src/simulation/scenes" \
        "$PROJECT_DIR/simulation/scenes" \
        "$PROJECT_DIR/scenes"; do
        if [ -f "$candidate/${scene}.js" ]; then
          echo "$candidate/${scene}.js"
          return
        fi
      done
      echo ""
    }

    SCENE_FILE=$(_find_scene_file "$SCENE")
    if [ -n "$SCENE_FILE" ]; then
      DURATION=${DURATION_FLAG:-$(_scene_opt "$SCENE_FILE" "duration" "35")}
      SETUP_DELAY=${SETUP_DELAY_FLAG:-$(_scene_opt "$SCENE_FILE" "setupDelay" "6")}
      RUN_DELAY=${RUN_DELAY_FLAG:-$(_scene_opt "$SCENE_FILE" "runDelay" "1")}
    else
      DURATION=${DURATION_FLAG:-35}
      SETUP_DELAY=${SETUP_DELAY_FLAG:-6}
      RUN_DELAY=${RUN_DELAY_FLAG:-1}
    fi

    RECORDINGS_DIR="$PROJECT_DIR/.openhive/recordings"
    mkdir -p "$RECORDINGS_DIR"
    TIMESTAMP=$(date +%Y%m%d-%H%M%S)
    OUTPUT="$RECORDINGS_DIR/${SCENE}-${TIMESTAMP}.mov"

    echo "=== Recording: $SCENE ==="
    echo "  Output:      $OUTPUT"
    echo "  Duration:    ${DURATION}s"
    echo "  Setup delay: ${SETUP_DELAY}s"
    echo "  Run delay:   ${RUN_DELAY}s"
    echo ""

    # Dismiss any system alerts or error overlays before recording
    source "$SCRIPTS_DIR/sim-helpers.sh"
    dismiss_alerts

    # Phase 1: Setup — create entities, navigate to screen, let UI settle
    echo "  [1/4] Setting up scene..."
    xcrun simctl openurl "$SIM_NAME" "${DEEP_LINK_SCHEME}://simulate?scene=$SCENE&action=setup"
    echo "  Waiting ${SETUP_DELAY}s for setup..."
    sleep "$SETUP_DELAY"

    # Phase 2: Start recording (UI is settled, plots are visible)
    echo "  [2/4] Starting recording..."
    xcrun simctl io "$SIM_NAME" recordVideo --codec h264 "$OUTPUT" &
    RECORD_PID=$!
    trap "kill -INT $RECORD_PID 2>/dev/null; wait $RECORD_PID 2>/dev/null; echo ''; echo 'Recording saved: $OUTPUT'; exit 0" INT
    sleep 2  # let recorder initialize

    # Phase 3: Small delay so recording captures the settled state briefly
    if [ "$RUN_DELAY" -gt 0 ] 2>/dev/null; then
      echo "  [3/4] Waiting ${RUN_DELAY}s before starting simulation..."
      sleep "$RUN_DELAY"
    fi

    # Phase 4: Run — start the date animation
    echo "  [4/4] Running simulation..."
    xcrun simctl openurl "$SIM_NAME" "${DEEP_LINK_SCHEME}://simulate?scene=$SCENE&action=run"

    echo "  Recording for ${DURATION}s... (Ctrl+C to stop early)"
    sleep "$DURATION"

    # Stop recording (SIGINT for clean .mov finalization)
    kill -INT "$RECORD_PID" 2>/dev/null
    wait "$RECORD_PID" 2>/dev/null

    echo ""
    echo "Recording saved: $OUTPUT"

    # Auto-clean status bar
    if [ -f "$OUTPUT" ]; then
      echo "  Cleaning status bar..."
      CLEAN_ARGS=(--device "$SIM_NAME")
      [ -n "${NO_CLEAN:-}" ] && CLEAN_ARGS=()
      if [ ${#CLEAN_ARGS[@]} -gt 0 ]; then
        "$SCRIPTS_DIR/clean-video.sh" "$OUTPUT" "${CLEAN_ARGS[@]}"
      fi
    fi
    ;;
  generate-scene)
    _load_config
    exec "$SCRIPTS_DIR/generate-scene.sh" "$@"
    ;;
  stop)
    _load_config
    exec "$SCRIPTS_DIR/stop.sh" "$@"
    ;;
  clean)
    _load_config
    exec "$SCRIPTS_DIR/clean-video.sh" --device "$SIM_NAME" "$@"
    ;;
  help|--help|-h)
    echo "ohmobile — Mobile simulator automation tools"
    echo ""
    echo "Usage: ohmobile <command> [options]"
    echo ""
    echo "Commands:"
    echo "  run              Build, launch, and authenticate (full flow)"
    echo "  run --skip-build Use cached Xcode build"
    echo "  run --skip-auth  Skip authentication step"
    echo "  auth             Authenticate on running simulator"
    echo "  creds            Set up keychain credentials interactively"
    echo "  creds --verify   Verify stored credentials against API"
    echo "  creds --delete   Delete stored credentials"
    echo "  stop             Stop this project's Metro bundler"
    echo "  stop --sim       Stop Metro and shut down simulator"
    echo "  scenes           List available simulation scenes"
    echo "  simulate <scene> Trigger a simulation scene via deep link"
    echo "  record <scene>   Record screen during a simulation scene"
    echo "  generate-scene   Generate a scene JS file using an AI agent"
    echo "  clean <file>     Remove status bar from a video or screenshot"
    echo "  help             Show this help"
    echo ""
    echo "Configuration:"
    echo "  Place a mobile.json5 file at .openhive/mobile.json5 in your project root."
    echo "  Override with \$OPENHIVE_MOBILE_CONFIG env var."
    echo "  Override project root with \$PROJECT_DIR env var."
    ;;
  *)
    echo "Unknown command: $CMD"
    echo "Run 'ohmobile help' for usage."
    exit 1
    ;;
esac
