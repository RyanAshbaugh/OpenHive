#!/bin/bash
set -euo pipefail

# ============================================================================
# ohmobile — CLI entry point for @openhive/mobile
# ============================================================================
#
# Usage:
#   ohmobile <command> [options]
#
# Commands:
#   run              Build, launch, and authenticate (full flow)
#   run --skip-build Use cached build
#   run --skip-auth  Skip authentication
#   auth             Authenticate on running simulator
#   creds            Set up keychain credentials
#   creds --verify   Verify stored credentials
#   creds --delete   Delete stored credentials
#   stop             Stop this project's Metro bundler
#   stop --sim       Stop Metro and shut down simulator
#   scenes           List available simulation scenes
#   simulate <scene> Trigger a simulation scene via deep link
#   record <scene>   Record a simulation (two-phase: setup then run)
#   generate-scene   Generate a scene JS file using an AI agent
#   help             Show this help
#

# Resolve symlinks so npm-linked installs find the real package location
_SELF="${BASH_SOURCE[0]:-$0}"
while [ -L "$_SELF" ]; do
  _DIR="$(cd "$(dirname "$_SELF")" && pwd)"
  _SELF="$(readlink "$_SELF")"
  [[ "$_SELF" != /* ]] && _SELF="$_DIR/$_SELF"
done
BIN_DIR="$(cd "$(dirname "$_SELF")" && pwd)"
SCRIPTS_DIR="$BIN_DIR/../scripts"

CMD="${1:-help}"
shift 2>/dev/null || true

# Load config for commands that need it
_load_config() {
  export PROJECT_DIR="${PROJECT_DIR:-$(pwd)}"
  source "$SCRIPTS_DIR/_load-config.sh"
}

# Find and list scene files in the project
_list_scenes() {
  local scenes_dir=""
  # Search common locations for scenes directory
  for candidate in \
    "$PROJECT_DIR/src/simulation/scenes" \
    "$PROJECT_DIR/simulation/scenes" \
    "$PROJECT_DIR/scenes"; do
    if [ -d "$candidate" ]; then
      scenes_dir="$candidate"
      break
    fi
  done

  local found=false

  if [ -n "$scenes_dir" ]; then
    local rel_dir="${scenes_dir#"$PROJECT_DIR"/}"
    echo "Scenes ($rel_dir/):"
    echo ""
    for f in "$scenes_dir"/*.js; do
      [ -f "$f" ] || continue
      local scene_name
      scene_name="$(basename "$f" .js)"
      [ "$scene_name" = "index" ] && continue
      echo "  $scene_name"
      found=true
    done
    for f in "$scenes_dir"/*.sh; do
      [ -f "$f" ] || continue
      local scene_name
      scene_name="$(basename "$f" .sh)"
      echo "  $scene_name  (scripted)"
      found=true
    done
  fi

  if [ "$found" = false ]; then
    echo "No scenes found."
    return 1
  fi
  echo ""
}

# Find a scene file by name — checks .js then .sh per search directory
_find_scene_file() {
  local scene="$1"
  for candidate in \
    "$PROJECT_DIR/src/simulation/scenes" \
    "$PROJECT_DIR/simulation/scenes" \
    "$PROJECT_DIR/scenes"; do
    if [ -f "$candidate/${scene}.js" ]; then
      echo "$candidate/${scene}.js"
      return
    fi
    if [ -f "$candidate/${scene}.sh" ]; then
      echo "$candidate/${scene}.sh"
      return
    fi
  done
  echo ""
}

case "$CMD" in
  run)
    exec "$SCRIPTS_DIR/build-and-run.sh" "$@"
    ;;
  auth)
    exec "$SCRIPTS_DIR/authenticate-sim.sh" "$@"
    ;;
  creds|credentials)
    exec "$SCRIPTS_DIR/setup-credentials.sh" "$@"
    ;;
  scenes)
    _load_config
    _list_scenes
    ;;
  simulate)
    _load_config
    SCENE="${1:-}"
    if [ -z "$SCENE" ] || [ "$SCENE" = "--list" ]; then
      echo "Usage: ohmobile simulate <scene>"
      echo ""
      echo "Runs a scene without recording."
      echo "  .js scenes send a deep link to the app's simulation engine."
      echo "  .sh scenes open a URL and run scripted UI automation."
      echo ""
      _list_scenes
      exit 0
    fi
    shift

    source "$SCRIPTS_DIR/sim-helpers.sh"
    dismiss_alerts

    SCENE_FILE=$(_find_scene_file "$SCENE")

    if [ -n "$SCENE_FILE" ] && [[ "$SCENE_FILE" == *.sh ]]; then
      # Scripted scene — open URL + run actions (no recording)
      source "$SCENE_FILE"
      echo "Running scripted scene: $SCENE"
      if [ -n "${SCENE_URL:-}" ]; then
        echo "  Opening URL: $SCENE_URL"
        xcrun simctl openurl "$SIM_NAME" "$SCENE_URL"
        echo "  Waiting for page to load..."
        sleep 3
      fi
      if [ -n "${SCENE_PRE_DELAY:-}" ] && [ "$SCENE_PRE_DELAY" -gt 0 ] 2>/dev/null; then
        echo "  Pre-delay ${SCENE_PRE_DELAY}s..."
        sleep "$SCENE_PRE_DELAY"
      fi
      echo "  Running scene actions..."
      run_scene
      echo "  Done."
    else
      # JS scene — deep link to in-app simulation engine
      SPEED="${1:-}"
      QUERY="scene=$SCENE"
      [ -n "$SPEED" ] && QUERY="$QUERY&speed=$SPEED"
      echo "Triggering simulation: $SCENE"
      xcrun simctl openurl "$SIM_NAME" "${DEEP_LINK_SCHEME}://simulate?$QUERY"
    fi
    ;;
  record)
    _load_config
    SCENE="${1:-}"
    if [ -z "$SCENE" ]; then
      echo "Usage: ohmobile record <scene> [options]"
      echo ""
      echo "Records the simulator screen while running a scene."
      echo ""
      echo "Scene types (determined by file extension):"
      echo "  .js  In-app simulation — two-phase deep-link flow (setup + run)"
      echo "  .sh  Scripted UI automation — opens a URL, runs tap/wait actions"
      echo ""
      echo "Options:"
      echo "  --duration <sec>      Recording duration (default: from scene file or 35)"
      echo "  --setup-delay <sec>   Wait after setup before recording (default: 6, JS only)"
      echo "  --run-delay <sec>     Wait after recording starts before running (default: 1, JS only)"
      echo "  --pre-delay <sec>     Seconds before actions start (default: from scene file or 2, scripted only)"
      echo ""
      echo "Examples:"
      echo "  ohmobile record my-scene                    # JS in-app simulation"
      echo "  ohmobile record my-script                   # scripted UI automation (.sh)"
      echo "  ohmobile record my-scene --duration 20 --setup-delay 8"
      exit 0
    fi
    shift

    # Parse CLI flags first
    DURATION_FLAG=""
    SETUP_DELAY_FLAG=""
    RUN_DELAY_FLAG=""
    PRE_DELAY_FLAG=""
    while [ $# -gt 0 ]; do
      case "$1" in
        --duration) DURATION_FLAG="$2"; shift 2 ;;
        --setup-delay) SETUP_DELAY_FLAG="$2"; shift 2 ;;
        --run-delay) RUN_DELAY_FLAG="$2"; shift 2 ;;
        --pre-delay) PRE_DELAY_FLAG="$2"; shift 2 ;;
        *) shift ;;
      esac
    done

    # Read a numeric value from the scene JS file's recording block
    _scene_opt() {
      local file="$1" key="$2" default="$3"
      local val
      val=$(grep -oE "${key}:\s*[0-9.]+" "$file" 2>/dev/null | grep -oE '[0-9.]+$' | head -1)
      echo "${val:-$default}"
    }

    SCENE_FILE=$(_find_scene_file "$SCENE")

    # Determine scene type from file extension
    SCENE_TYPE="js"
    if [ -n "$SCENE_FILE" ] && [[ "$SCENE_FILE" == *.sh ]]; then
      SCENE_TYPE="sh"
    fi

    # Load timing defaults from the scene file
    if [ "$SCENE_TYPE" = "sh" ] && [ -n "$SCENE_FILE" ]; then
      # Scripted scene: source to get SCENE_DURATION, SCENE_PRE_DELAY, SCENE_URL
      # (source in a subshell first to extract variables safely)
      SCENE_URL=$(bash -c "source '$SCENE_FILE' 2>/dev/null; echo \"\$SCENE_URL\"")
      DURATION=${DURATION_FLAG:-$(bash -c "source '$SCENE_FILE' 2>/dev/null; echo \"\${SCENE_DURATION:-35}\"")}
      PRE_DELAY=${PRE_DELAY_FLAG:-$(bash -c "source '$SCENE_FILE' 2>/dev/null; echo \"\${SCENE_PRE_DELAY:-2}\"")}
    elif [ -n "$SCENE_FILE" ]; then
      # JS scene
      DURATION=${DURATION_FLAG:-$(_scene_opt "$SCENE_FILE" "duration" "35")}
      SETUP_DELAY=${SETUP_DELAY_FLAG:-$(_scene_opt "$SCENE_FILE" "setupDelay" "6")}
      RUN_DELAY=${RUN_DELAY_FLAG:-$(_scene_opt "$SCENE_FILE" "runDelay" "1")}
    else
      DURATION=${DURATION_FLAG:-35}
      SETUP_DELAY=${SETUP_DELAY_FLAG:-6}
      RUN_DELAY=${RUN_DELAY_FLAG:-1}
    fi

    RECORDINGS_DIR="$PROJECT_DIR/.openhive/recordings"
    mkdir -p "$RECORDINGS_DIR"
    TIMESTAMP=$(date +%Y%m%d-%H%M%S)
    OUTPUT="$RECORDINGS_DIR/${SCENE}-${TIMESTAMP}.mov"

    # Dismiss any system alerts or error overlays before recording
    source "$SCRIPTS_DIR/sim-helpers.sh"
    dismiss_alerts

    if [ "$SCENE_TYPE" = "sh" ]; then
      # ── Scripted scene (.sh) ─────────────────────────────────────────
      echo "=== Recording (scripted): $SCENE ==="
      echo "  Output:    $OUTPUT"
      echo "  URL:       ${SCENE_URL:-<none>}"
      echo "  Duration:  ${DURATION}s"
      echo "  Pre-delay: ${PRE_DELAY:-2}s"
      echo ""

      # Source the scene file so run_scene() is available
      source "$SCENE_FILE"

      # Step 1: Open the URL on the simulator
      if [ -n "$SCENE_URL" ]; then
        echo "  [1/5] Opening URL..."
        xcrun simctl openurl "$SIM_NAME" "$SCENE_URL"
        echo "  Waiting for page to load..."
        sleep 3
      fi

      # Step 2: Start screen recording in background
      echo "  [2/5] Starting recording..."
      xcrun simctl io "$SIM_NAME" recordVideo --codec h264 "$OUTPUT" &
      RECORD_PID=$!
      trap "kill -INT $RECORD_PID 2>/dev/null; wait $RECORD_PID 2>/dev/null; echo ''; echo 'Recording saved: $OUTPUT'; exit 0" INT
      sleep 2  # let recorder initialize

      # Step 3: Pre-delay — capture loaded state before actions start
      PRE_DELAY="${PRE_DELAY:-2}"
      if [ "$PRE_DELAY" -gt 0 ] 2>/dev/null; then
        echo "  [3/5] Pre-delay ${PRE_DELAY}s (capturing loaded state)..."
        sleep "$PRE_DELAY"
      fi

      # Step 4: Execute the scene's UI automation
      echo "  [4/5] Running scene actions..."
      run_scene

      # Step 5: Hold for remaining duration
      echo "  [5/5] Holding for ${DURATION}s... (Ctrl+C to stop early)"
      sleep "$DURATION"

      # Stop recording
      kill -INT "$RECORD_PID" 2>/dev/null
      wait "$RECORD_PID" 2>/dev/null

    else
      # ── JS in-app simulation (.js) ──────────────────────────────────
      echo "=== Recording: $SCENE ==="
      echo "  Output:      $OUTPUT"
      echo "  Duration:    ${DURATION}s"
      echo "  Setup delay: ${SETUP_DELAY}s"
      echo "  Run delay:   ${RUN_DELAY}s"
      echo ""

      # Phase 1: Setup — create entities, navigate to screen, let UI settle
      echo "  [1/4] Setting up scene..."
      xcrun simctl openurl "$SIM_NAME" "${DEEP_LINK_SCHEME}://simulate?scene=$SCENE&action=setup"
      echo "  Waiting ${SETUP_DELAY}s for setup..."
      sleep "$SETUP_DELAY"

      # Phase 2: Start recording (UI is settled, plots are visible)
      echo "  [2/4] Starting recording..."
      xcrun simctl io "$SIM_NAME" recordVideo --codec h264 "$OUTPUT" &
      RECORD_PID=$!
      trap "kill -INT $RECORD_PID 2>/dev/null; wait $RECORD_PID 2>/dev/null; echo ''; echo 'Recording saved: $OUTPUT'; exit 0" INT
      sleep 2  # let recorder initialize

      # Phase 3: Small delay so recording captures the settled state briefly
      if [ "$RUN_DELAY" -gt 0 ] 2>/dev/null; then
        echo "  [3/4] Waiting ${RUN_DELAY}s before starting simulation..."
        sleep "$RUN_DELAY"
      fi

      # Phase 4: Run — start the date animation
      echo "  [4/4] Running simulation..."
      xcrun simctl openurl "$SIM_NAME" "${DEEP_LINK_SCHEME}://simulate?scene=$SCENE&action=run"

      echo "  Recording for ${DURATION}s... (Ctrl+C to stop early)"
      sleep "$DURATION"

      # Stop recording (SIGINT for clean .mov finalization)
      kill -INT "$RECORD_PID" 2>/dev/null
      wait "$RECORD_PID" 2>/dev/null
    fi

    echo ""
    echo "Recording saved: $OUTPUT"

    # Auto-clean status bar
    if [ -f "$OUTPUT" ]; then
      echo "  Cleaning status bar..."
      CLEAN_ARGS=(--device "$SIM_NAME")
      [ -n "${NO_CLEAN:-}" ] && CLEAN_ARGS=()
      if [ ${#CLEAN_ARGS[@]} -gt 0 ]; then
        "$SCRIPTS_DIR/clean-video.sh" "$OUTPUT" "${CLEAN_ARGS[@]}"
      fi
    fi
    ;;
  generate-scene)
    _load_config
    exec "$SCRIPTS_DIR/generate-scene.sh" "$@"
    ;;
  stop)
    _load_config
    exec "$SCRIPTS_DIR/stop.sh" "$@"
    ;;
  clean)
    _load_config
    exec "$SCRIPTS_DIR/clean-video.sh" --device "$SIM_NAME" "$@"
    ;;
  help|--help|-h)
    echo "ohmobile — Mobile simulator automation tools"
    echo ""
    echo "Usage: ohmobile <command> [options]"
    echo ""
    echo "Commands:"
    echo "  run              Build, launch, and authenticate (full flow)"
    echo "  run --skip-build Use cached Xcode build"
    echo "  run --skip-auth  Skip authentication step"
    echo "  auth             Authenticate on running simulator"
    echo "  creds            Set up keychain credentials interactively"
    echo "  creds --verify   Verify stored credentials against API"
    echo "  creds --delete   Delete stored credentials"
    echo "  stop             Stop this project's Metro bundler"
    echo "  stop --sim       Stop Metro and shut down simulator"
    echo "  scenes           List available simulation scenes"
    echo "  simulate <scene> Trigger a simulation scene via deep link"
    echo "  record <scene>   Record screen during a simulation scene"
    echo "  generate-scene   Generate a scene JS file using an AI agent"
    echo "  clean <file>     Remove status bar from a video or screenshot"
    echo "  help             Show this help"
    echo ""
    echo "Configuration:"
    echo "  Place a mobile.json5 file at .openhive/mobile.json5 in your project root."
    echo "  Override with \$OPENHIVE_MOBILE_CONFIG env var."
    echo "  Override project root with \$PROJECT_DIR env var."
    ;;
  *)
    echo "Unknown command: $CMD"
    echo "Run 'ohmobile help' for usage."
    exit 1
    ;;
esac
